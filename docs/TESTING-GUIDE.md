# 测试指南

## 测试修复的问题

### 问题 1: 409 冲突错误

#### 测试步骤

1. **打开 Figma 插件**
   - 在 Figma 中运行 zleap-icon 插件
   - 确保已配置 GitHub 设置

2. **选择图标**
   - 选择 5-10 个图标进行测试
   - 建议选择已存在的图标（测试更新场景）

3. **触发同步**
   - 选择"增量更新"模式
   - 填写版本号（如 1.2.3）
   - 填写更新说明
   - 点击"同步图标到 GitHub"

4. **观察控制台**
   - 打开浏览器开发者工具（F12）
   - 切换到 Console 标签
   - 查看上传日志

5. **预期结果**

   ```
   ✅ icon-a.svg 上传成功
   ✅ icon-b.svg 上传成功
   ✅ icon-c.svg 上传成功
   ...
   上传完成: 成功 10/10
   ✅ icons.json 上传成功
   ✅ PR 创建成功
   ```

6. **如果出现 409 错误**
   - 应该看到重试日志：

   ```
   文件 icon-x.svg 冲突，尝试获取最新 SHA...
   重试 1: 获取到新 SHA: 2476785...
   ✅ icon-x.svg 上传成功
   ```

7. **验证 PR**
   - 点击返回的 PR 链接
   - 检查 PR 中的文件变更
   - 确认所有图标都已上传

#### 成功标准

- ✅ 所有图标上传成功（或失败数量 < 10%）
- ✅ 409 错误自动重试并成功
- ✅ icons.json 文件已更新
- ✅ PR 创建成功

---

### 问题 2: 全量覆盖后旧图标仍显示

#### 测试步骤

1. **准备测试环境**
   - 确保仓库中有一些旧图标
   - 记录当前图标数量（如 40 个）

2. **在 Figma 中准备新图标**
   - 创建或选择 5-10 个新图标
   - 这些图标应该与旧图标不同

3. **打开插件并选择全量覆盖**
   - 运行 zleap-icon 插件
   - 选择"全量覆盖"模式
   - 阅读并确认警告对话框

4. **填写信息并同步**
   - 版本号：2.0.0（建议使用大版本号）
   - 更新说明："重新设计图标系统"
   - 点击"同步图标到 GitHub"

5. **观察控制台日志**

   ```
   正在删除旧图标...
   找到 40 个旧图标文件，准备删除...
   ✅ 已删除: icon-old-1.svg
   ✅ 已删除: icon-old-2.svg
   ...
   ✅ 已删除 40 个旧图标
   ✅ 已删除旧的 icons.json

   正在上传新图标...
   ✅ icon-new-1.svg 上传成功
   ✅ icon-new-2.svg 上传成功
   ...
   上传完成: 成功 10/10

   正在生成 icons.json...
   ✅ icons.json 上传成功

   正在创建 PR...
   ✅ PR 创建成功
   ```

6. **验证 PR 内容**
   - 打开 PR 链接
   - 检查"Files changed"标签
   - 应该看到：
     - 删除了 40 个旧 SVG 文件（红色）
     - 添加了 10 个新 SVG 文件（绿色）
     - 修改了 docs/public/icons.json（黄色）

7. **合并 PR**
   - 等待 CI/CD 构建完成
   - 合并 PR 到 main 分支
   - 等待 GitHub Pages 部署（约 2-5 分钟）

8. **验证文档网站**
   - 访问 https://ruofeng2015.github.io/zleap_icon/
   - 清除浏览器缓存（Ctrl+Shift+R 或 Cmd+Shift+R）
   - 检查图标列表

9. **预期结果**
   - ✅ 只显示 10 个新图标
   - ✅ 不显示任何旧图标
   - ✅ 所有图标都能正常加载（无 404 错误）
   - ✅ 图标数量显示为 10

#### 成功标准

- ✅ 旧图标已从仓库删除
- ✅ 新图标已上传
- ✅ icons.json 已更新
- ✅ 文档网站只显示新图标
- ✅ 无 404 错误

---

## 常见问题排查

### 问题：控制台没有日志

**解决方案**：

1. 确保打开了浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 清除过滤器（确保显示所有日志级别）

### 问题：上传失败率很高（> 20%）

**可能原因**：

- 网络连接不稳定
- GitHub API 速率限制
- Token 权限不足

**解决方案**：

1. 检查网络连接
2. 等待几分钟后重试
3. 验证 GitHub Token 权限（需要 `repo` 权限）
4. 减少批量大小（修改代码中的 `batchSize`）

### 问题：文档网站仍显示旧图标

**可能原因**：

- 浏览器缓存
- CDN 缓存
- GitHub Pages 未部署

**解决方案**：

1. 强制刷新浏览器（Ctrl+Shift+R）
2. 清除浏览器缓存
3. 等待 5-10 分钟（CDN 缓存过期）
4. 检查 GitHub Actions 部署状态
5. 验证 icons.json 文件内容

### 问题：icons.json 上传失败

**可能原因**：

- JSON 格式错误
- Base64 编码问题
- 权限问题

**解决方案**：

1. 查看控制台错误信息
2. 检查 GitHub Token 权限
3. 手动验证 JSON 格式
4. 重试上传

---

## 性能测试

### 小规模测试（5-10 个图标）

**预期时间**：

- 删除旧图标：5-10 秒（如果是全量覆盖）
- 上传新图标：10-20 秒
- 生成 icons.json：1-2 秒
- 创建 PR：2-3 秒
- **总计**：约 20-35 秒

### 中等规模测试（20-30 个图标）

**预期时间**：

- 删除旧图标：10-20 秒
- 上传新图标：30-60 秒
- 生成 icons.json：1-2 秒
- 创建 PR：2-3 秒
- **总计**：约 45-85 秒

### 大规模测试（50+ 个图标）

**预期时间**：

- 删除旧图标：20-40 秒
- 上传新图标：90-180 秒
- 生成 icons.json：1-2 秒
- 创建 PR：2-3 秒
- **总计**：约 2-4 分钟

**注意**：

- 时间会因网络速度而异
- GitHub API 速率限制可能影响性能
- 建议分批上传大量图标

---

## 回归测试清单

在发布新版本前，请完成以下测试：

### 基础功能

- [ ] 配置 GitHub 设置
- [ ] 加载图标列表
- [ ] 选择图标
- [ ] 填写版本号和说明

### 增量更新模式

- [ ] 添加新图标
- [ ] 更新现有图标
- [ ] 混合添加和更新
- [ ] 验证 PR 内容
- [ ] 验证文档网站

### 全量覆盖模式

- [ ] 显示警告对话框
- [ ] 删除所有旧图标
- [ ] 删除旧的 icons.json
- [ ] 上传新图标
- [ ] 生成新的 icons.json
- [ ] 验证 PR 内容
- [ ] 验证文档网站

### 错误处理

- [ ] 409 冲突自动重试
- [ ] 网络错误提示
- [ ] Token 权限错误提示
- [ ] 部分失败处理
- [ ] 用户取消操作

### 边界情况

- [ ] 0 个图标
- [ ] 1 个图标
- [ ] 100+ 个图标
- [ ] 特殊字符文件名
- [ ] 中文文件名
- [ ] 超大文件（> 1MB）

---

## 自动化测试

### 单元测试

```bash
npm test
```

### 集成测试

```bash
npm run test:integration
```

### 属性测试

```bash
npm run test:property
```

### 构建测试

```bash
npm run build
```

---

## 报告问题

如果测试失败，请提供以下信息：

1. **环境信息**
   - 操作系统
   - 浏览器版本
   - Figma 版本

2. **复现步骤**
   - 详细的操作步骤
   - 使用的配置
   - 选择的图标数量

3. **错误信息**
   - 控制台日志
   - 错误截图
   - PR 链接（如果创建了）

4. **预期行为**
   - 应该发生什么
   - 实际发生了什么

---

**更新日期：** 2026-01-19
**版本：** 2.1.0
