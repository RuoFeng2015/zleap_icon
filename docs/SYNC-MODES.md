# 同步模式说明

## 概述

Figma 插件支持两种同步模式：**增量更新**和**全量覆盖**。

## 同步模式对比

| 特性             | 增量更新          | 全量覆盖         |
| ---------------- | ----------------- | ---------------- |
| 保留旧图标       | ✅ 是             | ❌ 否            |
| 删除未选中的图标 | ❌ 否             | ✅ 是            |
| 适用场景         | 添加/更新部分图标 | 重新设计整套图标 |
| 风险             | 低                | 高（不可逆）     |
| 推荐使用         | ✅ 日常更新       | ⚠️ 谨慎使用      |

## 增量更新模式

### 特点

- **保留现有图标**：不会删除任何旧图标
- **添加新图标**：上传选中的新图标
- **更新现有图标**：如果图标已存在，会更新其内容
- **安全**：不会影响未选中的图标

### 使用场景

1. **添加新图标**

   ```
   现有: icon-a.svg, icon-b.svg
   上传: icon-c.svg
   结果: icon-a.svg, icon-b.svg, icon-c.svg ✅
   ```

2. **更新现有图标**

   ```
   现有: icon-a.svg (旧版本)
   上传: icon-a.svg (新版本)
   结果: icon-a.svg (新版本) ✅
   ```

3. **混合操作**
   ```
   现有: icon-a.svg, icon-b.svg
   上传: icon-a.svg (更新), icon-c.svg (新增)
   结果: icon-a.svg (新版本), icon-b.svg, icon-c.svg ✅
   ```

### 操作步骤

1. 在 Figma 中选择要添加/更新的图标
2. 运行插件
3. 选择 **"增量更新"** 模式
4. 填写版本号和更新说明
5. 点击"同步图标到 GitHub"

### PR 标题

```
🎨 图标更新: v1.2.0
```

### PR 内容

```markdown
## 图标更新

**版本:** 1.2.0
**说明:** 添加新的导航图标
**模式:** 增量更新

此 PR 由 Figma 插件自动生成。

### 变更内容

- ✅ 上传/更新了 5 个图标
```

## 全量覆盖模式

### 特点

- **删除所有旧图标**：清空 svg 目录
- **只保留本次上传的图标**：只包含选中的图标
- **不可逆**：删除的图标无法恢复（除非从 Git 历史恢复）
- **高风险**：需要谨慎使用

### 使用场景

1. **重新设计整套图标**

   ```
   现有: 50 个旧图标
   上传: 30 个新设计的图标
   结果: 只有 30 个新图标 ⚠️
   ```

2. **清理不再使用的图标**

   ```
   现有: icon-a.svg, icon-b.svg, icon-c.svg (不再使用)
   上传: icon-a.svg, icon-b.svg
   结果: 只有 icon-a.svg, icon-b.svg ⚠️
   ```

3. **统一图标风格**
   ```
   现有: 混合风格的图标
   上传: 统一风格的新图标
   结果: 只有新风格的图标 ⚠️
   ```

### 操作步骤

1. 在 Figma 中选择**所有**要保留的图标
2. 运行插件
3. 选择 **"全量覆盖"** 模式
4. **仔细阅读警告提示**
5. 确认操作
6. 填写版本号和更新说明
7. 点击"同步图标到 GitHub"

### 警告提示

```
⚠️ 警告：全量覆盖模式

此操作将：
1. 删除 svg 目录下的所有旧图标
2. 只保留本次上传的图标

这是一个不可逆的操作！

确定要继续吗？
```

### PR 标题

```
🔄 全量更新图标: v2.0.0
```

### PR 内容

```markdown
## 全量更新图标

**版本:** 2.0.0
**说明:** 重新设计整套图标系统
**模式:** 全量覆盖

此 PR 由 Figma 插件自动生成。

### 变更内容

- ⚠️ 删除了所有旧图标
- ✅ 上传了 30 个新图标

### 注意

这是一个全量覆盖更新，旧的图标已被删除。
```

## 工作流程

### 增量更新流程

```
1. 选择图标
   ↓
2. 运行插件
   ↓
3. 选择"增量更新"
   ↓
4. 填写信息
   ↓
5. 创建分支
   ↓
6. 上传选中的图标
   ↓
7. 创建 PR
   ↓
8. 自动构建
   ↓
9. 自动合并
```

### 全量覆盖流程

```
1. 选择所有要保留的图标
   ↓
2. 运行插件
   ↓
3. 选择"全量覆盖"
   ↓
4. 确认警告
   ↓
5. 填写信息
   ↓
6. 创建分支
   ↓
7. 删除所有旧图标 ⚠️
   ↓
8. 上传选中的图标
   ↓
9. 创建 PR
   ↓
10. 自动构建
   ↓
11. 自动合并
```

## 最佳实践

### 日常使用

**推荐：增量更新**

```
✅ 添加 1-5 个新图标
✅ 更新 1-3 个现有图标
✅ 修复图标问题
✅ 调整图标细节
```

### 大版本更新

**考虑：全量覆盖**

```
⚠️ 重新设计整套图标
⚠️ 更换图标风格
⚠️ 清理大量废弃图标
⚠️ 统一图标规范
```

### 安全建议

1. **备份重要图标**

   ```bash
   # 在全量覆盖前，备份 svg 目录
   cp -r svg svg_backup
   ```

2. **使用 Git 标签**

   ```bash
   # 在重大更新前打标签
   git tag -a v1.9.9 -m "Before icon redesign"
   git push origin v1.9.9
   ```

3. **分步骤更新**

   ```
   第一步：增量添加新图标
   第二步：测试新图标
   第三步：全量覆盖（如果需要）
   ```

4. **团队沟通**
   - 全量覆盖前通知团队
   - 确保没有人正在使用旧图标
   - 更新文档和使用指南

## 恢复删除的图标

如果误用全量覆盖模式删除了图标：

### 方法 1：从 Git 历史恢复

```bash
# 1. 查看历史提交
git log --oneline -- svg/

# 2. 找到删除前的提交
git show <commit-hash>:svg/icon-name.svg > svg/icon-name.svg

# 3. 提交恢复的文件
git add svg/icon-name.svg
git commit -m "Restore icon-name.svg"
git push
```

### 方法 2：从 PR 恢复

1. 找到删除图标的 PR
2. 查看 "Files changed" 标签
3. 复制被删除文件的内容
4. 手动创建文件并提交

### 方法 3：从备份恢复

如果有备份：

```bash
# 恢复备份的图标
cp svg_backup/icon-name.svg svg/
git add svg/icon-name.svg
git commit -m "Restore icon-name.svg from backup"
git push
```

## 常见问题

### Q: 什么时候应该使用全量覆盖？

A: 只在以下情况使用：

- 重新设计整套图标系统
- 确定要删除大量旧图标
- 已经备份了重要图标
- 团队已经知晓并同意

### Q: 全量覆盖会影响已发布的版本吗？

A: 不会。已发布到 NPM 的版本不受影响。但新版本将不包含被删除的图标。

### Q: 可以撤销全量覆盖操作吗？

A: 可以，但需要手动操作：

1. 不要合并 PR
2. 关闭 PR
3. 删除分支
4. 从 Git 历史恢复文件

### Q: 增量更新会删除图标吗？

A: 不会。增量更新只会添加或更新图标，不会删除任何图标。

### Q: 如何知道哪些图标会被删除？

A: 在全量覆盖模式下：

- 所有不在本次上传列表中的图标都会被删除
- 建议先在 Figma 中整理好所有要保留的图标

### Q: 可以部分删除图标吗？

A: 不能通过插件实现。如果需要删除特定图标：

1. 使用增量更新模式
2. 手动在 GitHub 上删除不需要的图标
3. 或使用 Git 命令删除

## 技术细节

### 删除逻辑

```javascript
if (syncMode === 'replace') {
  // 1. 获取 svg 目录下的所有文件
  const files = await getDirectoryContents('svg')

  // 2. 过滤出 .svg 文件
  const svgFiles = files.filter((f) => f.name.endsWith('.svg'))

  // 3. 批量删除
  for (const file of svgFiles) {
    await deleteFile(file.path, file.sha)
  }
}
```

### 上传逻辑

```javascript
// 增量更新：检查文件是否存在，如果存在则更新
if (syncMode === 'incremental') {
  const sha = await getFileSha(filePath)
  if (sha) {
    // 更新现有文件
    await updateFile(filePath, content, sha)
  } else {
    // 创建新文件
    await createFile(filePath, content)
  }
}

// 全量覆盖：直接创建（旧文件已删除）
if (syncMode === 'replace') {
  await createFile(filePath, content)
}
```

## 相关文档

- [上传失败排查指南](./UPLOAD-FAILURES.md)
- [GitHub 422 错误解决方案](./GITHUB-422-ERROR.md)
- [Figma 插件使用指南](../figma-plugin/README.md)

---

**更新日期：** 2026-01-19
**版本：** 2.0.0
